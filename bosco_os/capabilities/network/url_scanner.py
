"""
Bosco Core - URL Port Scanner
Scan ports on URLs and IP addresses with full nmap capabilities
"""

import subprocess
import socket
import re
from typing import Dict, List, Any, Optional, Tuple
from urllib.parse import urlparse


class URLPortScanner:
    """
    Advanced URL/IP port scanner with nmap integration
    """
    
    def __init__(self):
        self.nmap_available = self._check_nmap()
    
    def _check_nmap(self) -> bool:
        """Check if nmap is installed"""
        try:
            result = subprocess.run(['which', 'nmap'], capture_output=True)
            return result.returncode == 0
        except:
            return False
    
    def resolve_url(self, url: str) -> Tuple[Optional[str], Optional[str]]:
        """
        Resolve URL to IP address and hostname
        
        Returns: (ip_address, hostname)
        """
        # Clean the input
        url = url.strip()
        
        # If it's already an IP, return it
        if self._is_ip(url):
            return url, url
        
        # Remove protocol if present
        if '://' in url:
            parsed = urlparse(url)
            hostname = parsed.hostname or url
            port = parsed.port
        else:
            # Check if it has a path
            if '/' in url:
                hostname = url.split('/')[0]
            else:
                hostname = url
            port = None
        
        # Remove port from hostname if present
        if ':' in hostname:
            parts = hostname.rsplit(':', 1)
            hostname = parts[0]
            try:
                port = int(parts[1]) if port is None else port
            except:
                pass
        
        # Resolve to IP
        try:
            ip = socket.gethostbyname(hostname)
            return ip, hostname
        except socket.gaierror:
            return None, hostname
    
    def _is_ip(self, text: str) -> bool:
        """Check if text is an IP address"""
        ip_pattern = r'^(\d{1,3}\.){3}\d{1,3}$'
        return bool(re.match(ip_pattern, text.strip()))
    
    def scan_ports(self, target: str, ports: str = None, scan_type: str = 'basic',
                   timeout: int = 60) -> str:
        """
        Scan ports on target URL or IP
        
        Args:
            target: URL or IP address
            ports: Port range (e.g., "1-1000", "80,443,22")
            scan_type: basic, quick, stealth, full, udp
            timeout: Command timeout in seconds
            
        Returns:
            Formatted scan results
        """
        # Resolve URL to IP if needed
        ip, hostname = self.resolve_url(target)
        
        if ip is None:
            return f"Error: Could not resolve {target}"
        
        # Build nmap command
        if scan_type == 'basic':
            flags = '-sV'
            ports = ports or '1-1000'
        elif scan_type == 'quick':
            flags = '-sV'
            ports = ports or '80,443,22,21,25,3389,8080,8443'
        elif scan_type == 'stealth':
            flags = '-sS -T stealth'
            ports = ports or '1-1000'
        elif scan_type == 'full':
            flags = '-A -p-'
            ports = ports or '1-65535'
        elif scan_type == 'udp':
            flags = '-sU'
            ports = ports or '53,67,68,123,161,162'
        elif scan_type == 'vuln':
            flags = '-sV --script vuln'
            ports = ports or '1-1000'
        else:
            flags = '-sV'
            ports = ports or '1-1000'
        
        # Build command
        if ports:
            cmd = f"nmap {flags} -p {ports} {ip}"
        else:
            cmd = f"nmap {flags} {ip}"
        
        try:
            result = subprocess.run(
                cmd.split(),
                capture_output=True,
                text=True,
                timeout=timeout
            )
            
            output = result.stdout if result.stdout else result.stderr
            
            # Format output with target info
            header = f"Port Scan Results for: {target}\n"
            header += f"Resolved IP: {ip}\n"
            header += f"Hostname: {hostname}\n"
            header += f"Scan Type: {scan_type}\n"
            header += "=" * 60 + "\n"
            
            return header + output
        
        except subprocess.TimeoutExpired:
            return f"Scan timed out after {timeout} seconds"
        except Exception as e:
            return f"Scan error: {str(e)}"
    
    def quick_scan(self, target: str) -> str:
        """Quick scan of common ports"""
        return self.scan_ports(target, scan_type='quick')
    
    def full_scan(self, target: str) -> str:
        """Full port scan with OS detection"""
        return self.scan_ports(target, scan_type='full', timeout=180)
    
    def stealth_scan(self, target: str) -> str:
        """Stealth SYN scan"""
        return self.scan_ports(target, scan_type='stealth')
    
    def vuln_scan(self, target: str) -> str:
        """Vulnerability scan"""
        return self.scan_ports(target, scan_type='vuln', timeout=120)
    
    def check_single_port(self, target: str, port: int) -> Dict[str, Any]:
        """Check if a specific port is open"""
        ip, hostname = self.resolve_url(target)
        
        if ip is None:
            return {'success': False, 'error': f"Could not resolve {target}"}
        
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(5)
        
        try:
            result = sock.connect_ex((ip, port))
            is_open = result == 0
            
            return {
                'success': True,
                'target': target,
                'ip': ip,
                'port': port,
                'is_open': is_open,
                'service': self._guess_service(port) if is_open else None
            }
        except Exception as e:
            return {'success': False, 'error': str(e)}
        finally:
            sock.close()
    
    def _guess_service(self, port: int) -> str:
        """Guess service name from port number"""
        common_ports = {
            20: 'FTP-DATA', 21: 'FTP', 22: 'SSH', 23: 'TELNET',
            25: 'SMTP', 53: 'DNS', 67: 'DHCP', 68: 'DHCP',
            80: 'HTTP', 110: 'POP3', 119: 'NNTP', 123: 'NTP',
            143: 'IMAP', 161: 'SNMP', 162: 'SNMP-TRAP', 443: 'HTTPS',
            445: 'SMB', 465: 'SMTPS', 587: 'SMTP', 993: 'IMAPS',
            995: 'POP3S', 1433: 'MSSQL', 1521: 'ORACLE', 3306: 'MySQL',
            3389: 'RDP', 5432: 'PostgreSQL', 5900: 'VNC', 6379: 'Redis',
            8080: 'HTTP-ALT', 8443: 'HTTPS-ALT', 27017: 'MongoDB'
        }
        return common_ports.get(port, 'Unknown')
    
    def check_open_ports(self, target: str) -> str:
        """Check open ports on target (simplified version)"""
        return self.quick_scan(target)
    
    def scan_url(self, url: str, ports: str = None) -> str:
        """Scan ports on a URL"""
        return self.scan_ports(url, ports=ports, scan_type='basic')


# Global instance
_scanner = None

def get_url_scanner() -> URLPortScanner:
    """Get URL scanner instance"""
    global _scanner
    if _scanner is None:
        _scanner = URLPortScanner()
    return _scanner


# Convenience functions
def scan_ports(target: str, ports: str = None, scan_type: str = 'basic') -> str:
    """Scan ports on target"""
    return get_url_scanner().scan_ports(target, ports, scan_type)

def quick_scan(target: str) -> str:
    """Quick port scan"""
    return get_url_scanner().quick_scan(target)

def full_scan(target: str) -> str:
    """Full port scan"""
    return get_url_scanner().full_scan(target)

def check_open_ports(target: str) -> str:
    """Check open ports"""
    return get_url_scanner().check_open_ports(target)


if __name__ == "__main__":
    # Test the scanner
    scanner = URLPortScanner()
    
    print("=== URL Port Scanner Test ===\n")
    
    # Test URL resolution
    test_urls = [
        "google.com",
        "https://github.com",
        "8.8.8.8",
        "localhost"
    ]
    
    for url in test_urls:
        ip, hostname = scanner.resolve_url(url)
        print(f"{url} -> IP: {ip}, Hostname: {hostname}")
    
    print("\n--- Quick Scan (google.com) ---")
    print(scanner.quick_scan("google.com")[:500])

